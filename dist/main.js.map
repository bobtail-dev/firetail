{"version":3,"sources":["../src/main.js"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["import {autoSub, bind, array, transaction} from 'bobtail-rx';\nimport {ObsJsonCell, DepJsonCell} from 'bobtail-json-cell';\nimport _ from 'underscore';\nimport safeSet from 'lodash.set';\n\nlet listEvents = {\n  child_added(data){\n    return this._reloading(() => safeSet(this, ['data', data.key], data.val()));\n  },\n  child_changed(data){\n    return this._reloading(() => safeSet(this, ['data', data.key], data.val()));\n  },\n  child_removed(data){\n    return this._reloading(() => delete this.data[data.key]);\n  }\n};\n\nfunction initCell ([o, n]) {\n  if(o) {\n    o.off();  // turn off old listeners, if any\n  }\n  return n.on('value', data => this._reload(data.val()));\n}\n\nfunction initList ([o, n]) {\n  if(o) {\n    o.off();  // turn off old listeners, if any\n  }\n  let entries = Object.entries(listEvents);\n  this._reload({});\n  entries.map(([ev, handler]) => n.on(ev, handler.bind(this)));\n}\n\nclass FireTailBase extends ObsJsonCell {\n  constructor(refFn, init=null) {\n    super(init);\n    this.refFn = typeof refFn === 'function' ? refFn: () => refFn;\n    this.refCell = bind(this.refFn);\n    this._nowReloading = false;\n  }\n  _reload(data) {\n    this._reloading(() => this._update(data));\n  }\n  _reloading(f) {\n    let _wasReloading = this._nowReloading;\n    this._nowReloading = true;\n    try {this._updating(f)} finally {\n      this._nowReloading = _wasReloading;\n    }\n  }\n}\n\nclass DepFireTailBase extends FireTailBase {\n  constructor() {\n    super(...arguments)._makeReadOnly();\n  }\n}\n\nexport class DepFireTailCell extends DepFireTailBase {\n  constructor(refFn, init=null) {\n    super(refFn, init);\n    autoSub(this.refCell.onSet, initCell.bind(this))\n  }\n}\n\nexport class DepFireTailList extends DepFireTailBase {\n  constructor(refFn, init) {\n    super(refFn, init || {});\n    autoSub(this.refCell.onSet, initList.bind(this));\n  }\n}\n\n\nclass RWFireTailBase extends FireTailBase {\n  constructor(refFn, init, events) {\n    super(refFn, init, events);\n  }\n  setProperty (getPath, basePath, obj, prop, val) {\n    super.setProperty(getPath, basePath, obj, prop, val);\n    if(!this._nowReloading) {\n      let path = getPath(prop).slice(1).join('/');\n      this.refCell.raw().ref.update({[path]: val});\n    }\n    return true;\n  }\n  deleteProperty (getPath, basePath, obj, prop) {\n    super.deleteProperty(getPath, basePath, obj, prop);\n    if(!this._nowReloading) {\n      this.refCell.raw().ref.update({[getPath(prop).slice(1).join('/')]: null});\n    }\n    return true;\n  }\n  set data(val) {this._update(val);}\n  get data() {return this._data.value;}\n}\n\nexport class RWFireTailCell extends RWFireTailBase {\n  constructor(refFn, init) {\n    super(refFn, init);\n    autoSub(this.refCell.onSet, initCell.bind(this));\n  }\n}\n\nexport class RWFireTailList extends RWFireTailBase {\n  constructor(refFn, init) {\n    super(refFn, init || {});\n    autoSub(this.refCell.onSet, initList.bind(this));\n  }\n  push(elem) {\n    let ref = this.refCell.raw().ref.push();\n    ref.set(elem);\n    return ref;\n  }\n}\n\nlet FIRE_KEY = Symbol(\"fire_key\");\n\nclass BaseSyncArray extends FireTailBase {\n  constructor(refFn, init=[]) {\n    super(refFn, init);\n    this._valuesPlucked = new Proxy(super.data, this.conf());\n\n    autoSub(this.refCell.onSet, ([o, n]) => {\n      if(o) {o.off();}\n\n      this._initListeners();\n      // this dance is necessary to handle primitives while keeping their key associated with them\n    });\n  }\n  _monit (event, method) {\n    this.refCell.raw().on(event, method.bind(this));\n  };\n\n  _initListeners () {\n    this._monit('child_added', this._serverAdd);\n    this._monit('child_removed', this._serverRemove);\n    this._monit('child_changed', this._serverChange);\n    this._monit('child_moved', this._serverMove);\n  };\n\n  _serverAdd (snap, prevId) {\n    this._reloading(() => {\n      let data = {value: snap.val(), [FIRE_KEY]: snap.key};\n      this._moveTo(data, prevId);\n    });\n  };\n\n  _serverRemove (snap) {\n    this._reloading(() => {\n      let pos = this.posByKey(snap.key);\n      if( pos !== -1 ) {\n        super.data.splice(pos, 1);\n      }\n    });\n  };\n\n  _serverChange (snap) {\n    this._reloading(() => {\n      let pos = this.posByKey(snap.key);\n      if( pos !== -1 ) {\n        this.data[pos] = {key: snap.key, value: snap.val()};\n      }\n    });\n  };\n\n  _serverMove (snap, prevId) {\n    this._reloading(() => {\n      let id = snap.key;\n      let oldPos = this.posByKey(id);\n      if( oldPos !== -1 ) {\n        let data = this.data[oldPos];\n        this.data.splice(oldPos, 1);\n        this._moveTo(id, data, prevId);\n      }\n    });\n  };\n\n  _moveTo (data, prevId) {\n    let pos = this.posByKey(prevId);\n    super.data.splice(pos, 0, data);\n  };\n\n  posByKey (key) {\n    return _.findIndex(super.data, (data) => data[FIRE_KEY] === key)\n  };\n\n  conf () {\n    return {\n      get(obj, key) {\n        let base = obj[key];\n        if(key in obj && typeof key !== 'symbol' && !isNaN(key)) {\n          return base.value;\n        }\n        return base;\n      }\n    }\n  }\n}\n\nexport class DepSyncArray extends BaseSyncArray {\n  constructor(refFn, init) {\n    super(refFn, init || []);\n    this._makeReadOnly();\n  }\n  get data() {\n    return this._valuesPlucked;\n  }\n}\n"]}