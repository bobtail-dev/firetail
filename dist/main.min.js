!function(t,e){if("function"==typeof define&&define.amd)define("bobtail-deep-cell",["exports","bobtail-rx","bobtail-json-cell","underscore","lodash.set"],e);else if("undefined"!=typeof exports)e(exports,require("bobtail-rx"),require("bobtail-json-cell"),require("underscore"),require("lodash.set"));else{var r={exports:{}};e(r.exports,t.rx,t.bobtailJsonCell,t.underscore,t.lodashSet),t.bobtailDeepCell=r.exports}}(this,function(t,e,r,n,o){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}function a(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function f(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function c(t){var e=this,r=v(t,2),n=r[0],o=r[1];return n&&n.off(),o.on("value",function(t){return e._reload(t.val())})}function s(t){var e=this,r=v(t,2),n=r[0],o=r[1];n&&n.off();var i=Object.entries(b);this._reload({}),i.map(function(t){var r=v(t,2),n=r[0],i=r[1];return o.on(n,i.bind(e))})}Object.defineProperty(t,"__esModule",{value:!0}),t.DepSyncArray=t.RWFireTailList=t.RWFireTailCell=t.DepFireTailList=t.DepFireTailCell=void 0;var p=i(n),y=i(o),_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d=function t(e,r,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,r);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},h=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),v=function(){function t(t,e){var r=[],n=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){o=!0,i=t}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),b={child_added:function(t){var e=this;return this._reloading(function(){return(0,y.default)(e,["data",t.key],t.val())})},child_changed:function(t){var e=this;return this._reloading(function(){return(0,y.default)(e,["data",t.key],t.val())})},child_removed:function(t){var e=this;return this._reloading(function(){return delete e.data[t.key]})}},g=function(t){function n(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;u(this,n);var o=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,r));return o.refFn="function"==typeof t?t:function(){return t},o.refCell=(0,e.bind)(o.refFn),o._nowReloading=!1,o}return f(n,r.ObsJsonCell),h(n,[{key:"_reload",value:function(t){var e=this;this._reloading(function(){return e._update(t)})}},{key:"_reloading",value:function(t){var e=this._nowReloading;this._nowReloading=!0;try{this._updating(t)}finally{this._nowReloading=e}}}]),n}(),O=function(t){function e(){var t;return u(this,e),(t=l(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments)))._makeReadOnly(),t}return f(e,g),e}(),m=(t.DepFireTailCell=function(t){function r(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;u(this,r);var o=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,n));return(0,e.autoSub)(o.refCell.onSet,c.bind(o)),o}return f(r,O),r}(),t.DepFireTailList=function(t){function r(t,n){u(this,r);var o=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,n||{}));return(0,e.autoSub)(o.refCell.onSet,s.bind(o)),o}return f(r,O),r}(),function(t){function e(t,r,n){return u(this,e),l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r,n))}return f(e,g),h(e,[{key:"setProperty",value:function(t,r,n,o,i){if(d(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setProperty",this).call(this,t,r,n,o,i),!this._nowReloading){var u=t(o).slice(1).join("/");this.refCell.raw().ref.update(a({},u,i))}return!0}},{key:"deleteProperty",value:function(t,r,n,o){return d(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteProperty",this).call(this,t,r,n,o),this._nowReloading||this.refCell.raw().ref.update(a({},t(o).slice(1).join("/"),null)),!0}},{key:"data",set:function(t){this._update(t)},get:function(){return this._data.value}}]),e}()),k=(t.RWFireTailCell=function(t){function r(t,n){u(this,r);var o=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,n));return(0,e.autoSub)(o.refCell.onSet,c.bind(o)),o}return f(r,m),r}(),t.RWFireTailList=function(t){function r(t,n){u(this,r);var o=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,n||{}));return(0,e.autoSub)(o.refCell.onSet,s.bind(o)),o}return f(r,m),h(r,[{key:"push",value:function(t){var e=this.refCell.raw().ref.push();return e.set(t),e}}]),r}(),Symbol("fire_key")),j=function(t){function r(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];u(this,r);var o=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,n));return o._valuesPlucked=new Proxy(d(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"data",o),o.conf()),(0,e.autoSub)(o.refCell.onSet,function(t){var e=v(t,2),r=e[0];e[1];r&&r.off(),o._initListeners()}),o}return f(r,g),h(r,[{key:"_monit",value:function(t,e){this.refCell.raw().on(t,e.bind(this))}},{key:"_initListeners",value:function(){this._monit("child_added",this._serverAdd),this._monit("child_removed",this._serverRemove),this._monit("child_changed",this._serverChange),this._monit("child_moved",this._serverMove)}},{key:"_serverAdd",value:function(t,e){var r=this;this._reloading(function(){var n=a({value:t.val()},k,t.key);r._moveTo(n,e)})}},{key:"_serverRemove",value:function(t){var e=this;this._reloading(function(){var n=e.posByKey(t.key);-1!==n&&d(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"data",e).splice(n,1)})}},{key:"_serverChange",value:function(t){var e=this;this._reloading(function(){var r=e.posByKey(t.key);-1!==r&&(e.data[r]={key:t.key,value:t.val()})})}},{key:"_serverMove",value:function(t,e){var r=this;this._reloading(function(){var n=t.key,o=r.posByKey(n);if(-1!==o){var i=r.data[o];r.data.splice(o,1),r._moveTo(n,i,e)}})}},{key:"_moveTo",value:function(t,e){var n=this.posByKey(e);d(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"data",this).splice(n,0,t)}},{key:"posByKey",value:function(t){return p.default.findIndex(d(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"data",this),function(e){return e[k]===t})}},{key:"conf",value:function(){return{get:function(t,e){var r=t[e];return e in t&&"symbol"!==(void 0===e?"undefined":_(e))&&!isNaN(e)?r.value:r}}}}]),r}();t.DepSyncArray=function(t){function e(t,r){u(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r||[]));return n._makeReadOnly(),n}return f(e,j),h(e,[{key:"data",get:function(){return this._valuesPlucked}}]),e}()});