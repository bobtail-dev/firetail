!function(e,t){if("function"==typeof define&&define.amd)define("bobtail-deep-cell",["exports","bobtail-rx","bobtail-json-cell","underscore","lodash.set"],t);else if("undefined"!=typeof exports)t(exports,require("bobtail-rx"),require("bobtail-json-cell"),require("underscore"),require("lodash.set"));else{var r={exports:{}};t(r.exports,e.rx,e.bobtailJsonCell,e.underscore,e.lodashSet),e.bobtailDeepCell=r.exports}}(this,function(e,t,r,n,i){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function f(e){var t=this,r=p(e,2),n=r[0],i=r[1];return n&&n.off(),i.on("value",function(e){return t._reload(e.val())})}function c(e){var t=this,r=p(e,2),n=r[0],i=r[1];n&&n.off();var o=Object.entries(y);this._reload({}),o.map(function(e){var r=p(e,2),n=r[0],o=r[1];return i.on(n,o.bind(t))})}Object.defineProperty(e,"__esModule",{value:!0}),e.DepSyncArray=e.RWFireTailList=e.RWFireTailCell=e.DepFireTailList=e.DepFireTailCell=void 0;var h=o(n),d=o(i),v=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},_=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),p=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),y={child_added:function(e){var t=this;return this._reloading(function(){return(0,d.default)(t,["data",e.key],e.val())})},child_changed:function(e){var t=this;return this._reloading(function(){return(0,d.default)(t,["data",e.key],e.val())})},child_removed:function(e){var t=this;return this._reloading(function(){return delete t.data[e.key]})}},b=function(e){function n(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;u(this,n);var i=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,r));return i.refFn="function"==typeof e?e:function(){return e},i.refCell=(0,t.bind)(i.refFn),i._nowReloading=!1,i}return s(n,r.ObsJsonCell),_(n,[{key:"_reload",value:function(e){var t=this;this._reloading(function(){return t._update(e)})}},{key:"_reloading",value:function(e){var t=this._nowReloading;this._nowReloading=!0;try{this._updating(e)}finally{this._nowReloading=t}}}]),n}(),g=function(e){function t(){var e;return u(this,t),(e=l(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments)))._makeReadOnly(),e}return s(t,b),t}(),O=(e.DepFireTailCell=function(e){function r(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;u(this,r);var i=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,n));return(0,t.autoSub)(i.refCell.onSet,f.bind(i)),i}return s(r,g),r}(),e.DepFireTailList=function(e){function r(e,n){u(this,r);var i=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,n||{}));return(0,t.autoSub)(i.refCell.onSet,c.bind(i)),i}return s(r,g),r}(),function(e){function t(e,r,n){return u(this,t),l(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n))}return s(t,b),_(t,[{key:"setProperty",value:function(e,r,n,i,o){if(v(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setProperty",this).call(this,e,r,n,i,o),!this._nowReloading){var u=e(i).slice(1).join("/");this.refCell.raw().ref.update(a({},u,o))}return!0}},{key:"deleteProperty",value:function(e,r,n,i){return v(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"deleteProperty",this).call(this,e,r,n,i),this._nowReloading||this.refCell.raw().ref.update(a({},e(i).slice(1).join("/"),null)),!0}},{key:"data",set:function(e){this._update(e)},get:function(){return this._data.value}}]),t}()),k=(e.RWFireTailCell=function(e){function r(e,n){u(this,r);var i=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,n));return(0,t.autoSub)(i.refCell.onSet,f.bind(i)),i}return s(r,O),r}(),e.RWFireTailList=function(e){function r(e,n){u(this,r);var i=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,n||{}));return(0,t.autoSub)(i.refCell.onSet,c.bind(i)),i}return s(r,O),_(r,[{key:"push",value:function(e){var t=this.refCell.raw().ref.push();return t.set(e),t}}]),r}(),function(e){function r(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];u(this,r);var i=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,n));return(0,t.autoSub)(i.refCell.onSet,function(e){var t=p(e,2),r=t[0];t[1];r&&r.off(),i._initListeners()}),i}return s(r,b),_(r,[{key:"_monit",value:function(e,t){this.refCell.raw().on(e,t.bind(this))}},{key:"_initListeners",value:function(){this._monit("child_added",this._serverAdd),this._monit("child_removed",this._serverRemove),this._monit("child_changed",this._serverChange),this._monit("child_moved",this._serverMove)}},{key:"_serverAdd",value:function(e,t){var r=this;this._reloading(function(){var n={value:e.val(),key:e.key};r._moveTo(n,t)})}},{key:"_serverRemove",value:function(e){var t=this;this._reloading(function(){var r=t.posByKey(e.key);-1!==r&&t._data.value.splice(r,1)})}},{key:"_serverChange",value:function(e){var t=this;this._reloading(function(){var r=t.posByKey(e.key);-1!==r&&(t._data.value[r]={key:e.key,value:e.val()})})}},{key:"_serverMove",value:function(e,t){var r=this;this._reloading(function(){var n=e.key,i=r.posByKey(n);-1!==i&&(r._data.value.splice(i,1),r._moveTo({value:e.val(),key:e.key},t))})}},{key:"_moveTo",value:function(e,t){var r=this.posByKey(t);this._data.value.splice(r+1,0,e)}},{key:"posByKey",value:function(e){return h.default.findIndex(this._data.value,function(t){return t.key===e})}},{key:"keys",value:function(){return this._data.value.map(function(e){return e.key})}},{key:"data",get:function(){return h.default.pluck(this._data.value,"value")}}]),r}());e.DepSyncArray=function(e){function t(e,r){u(this,t);var n=l(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r||[]));return n._makeReadOnly(),n}return s(t,k),t}()});